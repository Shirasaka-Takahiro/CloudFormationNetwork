AWSTemplateFormatVersion: "2010-09-09"
Description: 
  CloudFront and S3 for Website hosting

Metadata:
  "AWS::CloudFormation::Interface":
    ParameterGroups:
      - Label: 
          default: "CloudFront and S3 Configuration"
        Parameters: 
          - WebsiteDomainName
          - CFSSLCertificateId

    ParameterLabels: 
      WebsiteDomainName: 
        default: "WebsiteDomainName"
      CFSSLCertificateId: 
        default: "CFSSLCertificateId"

# Input Parameters
Parameters:
  WebsiteDomainName:
    Type: String

  CFSSLCertificateId:
    Type: String

Resources:
#  S3 Bucket   
# Bucket
  WebSiteHostingBucket:
    Type: "AWS::S3::Bucket"
    Properties:
      BucketName: !Ref WebsiteDomainName
      AccessControl: PublicRead
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: error.html
      LoggingConfiguration:
        DestinationBucketName: !Ref 'S3AcessLogBucket'
      VersioningConfiguration:
        Status: Enabled
      Tags:
        - Key: Name
          Value: !Sub "{WebsiteDomainName}"-hosting-bucket
  S3AcessLogBucket:
    Type: "AWS::S3::Bucket"
    Properties:
      BucketName: !Sub "{WebsiteDomainName}"-S3-accesslog-bucket
      AccessControl: LogDeliveryWrite
      Tags:
        - Key: Name
          Value: !Sub "{WebsiteDomainName}"-S3-accesslog-bucket
  CFAccessLogBucket:
    Type: "AWS::S3::Bucket"
    Properties:
      BucketName: !Sub "{WebsiteDomainName}"-CF-accesslog-bucket
      AccessControl: LogDeliveryWrite
      Tags:
        - Key: Name
          Value: !Sub "{WebsiteDomainName}"-CF-accesslog-bucket
  
  WebSiteHostingBucketPolicy:
    Type: "AWS::S3::BucketPolicy"
    Properties:
      Bucket: !Ref WebSiteHostingBucket
      PolicyDocument:
        Statement:
        - Action: "s3:GetObject"
          Effect: Allow
          Resource: !Sub "arn:aws:s3:::${WebSiteHostingBucket}/*"
          Principal: '*'

#  CloudFront
  CloudFrontDistribution:
    Type: "AWS::CloudFront::Distribution"
    Properties:
      DistributionConfig:
        PriceClass: PriceClass_All
        Aliases:
        - !Ref WebsiteDomainName
        Origins:
        - CustomOriginConfig:
            OriginProtocolPolicy: http-only
          DomainName: !Sub "${WebsiteDomainName}.s3-website-${AWS::Region}.amazonaws.com"
          Id: !Sub "S3-Website-${WebsiteDomainName}.s3-website-ap-northeast-1.amazonaws.com"
          Logging:
          IncludeCookies: 'false'
          Bucket: !Ref CFAccessLogBucket
        DefaultCacheBehavior:
          TargetOriginId: !Sub "S3-Website-${WebsiteDomainName}.s3-website-ap-northeast-1.amazonaws.com"
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
          - GET
          - HEAD
          CachedMethods:
          - GET
          - HEAD
          DefaultTTL: 3600
          MaxTTL: 86400
          MinTTL: 60
          Compress: true
          ForwardedValues:
            Cookies:
              Forward: none
            QueryString: false
        ViewerCertificate:
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.1_2016
          AcmCertificateArn: !Sub "arn:aws:acm:us-east-1:${AWS::AccountId}:certificate/${CFSSLCertificateId}"
        HttpVersion: http2
        Enabled: true